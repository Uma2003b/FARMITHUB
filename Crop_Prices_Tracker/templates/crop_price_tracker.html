<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crop Price Tracker - AgriConnectHub</title>
    <link rel="stylesheet" href="{{ url_for('crop_price_tracker.static', filename='styles.css') }}">
    <link rel="stylesheet" href="../../theme.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  </head>

  <body>
    <div class="header-nav-wrapper">
      <header class="uniform-header">
        <div class="brand">
          <h2>Welcome to AgriConnectHub</h2>
        </div>
        <div class="header-buttons">
          <a href="../../../cropCalendar.html" class="calendar-button" title="Crop Calendar">
            <span class="calendar-icon">üìÖ</span> Calendar
          </a>
          <a href="../../../feed-back.html" class="feedback-button">Feedback</a>
          <a href="#" class="logout-button" onclick="showLogoutConfirmation()">Logout</a>
          <button class="theme-toggle" aria-label="Toggle dark/light mode">
            <i class="fas fa-sun sun-icon"></i>
            <i class="fas fa-moon moon-icon"></i>
            <span class="theme-text">Light</span>
          </button>
        </div>
      </header>

      <nav>
        <ul>
          <li><a href="/crop_recommendation/">üå± Crop Recommendation</a></li>
          <li><a href="/crop_yield/">üìä Yield Prediction</a></li>
          <li><a href="../../../disease.html">üî¨ Disease Prediction</a></li>
          <li><a href="../../../organic.html">üåø Organic Farming</a></li>
          <li><a href="../../../farmer.html">üë• Farmer Network</a></li>
          <li><a href="../../../weather.html">‚õÖ Weather Check</a></li>
          <li><a href="../../../shopkeeper.html">üè™ Shopkeeper Listings</a></li>
          <li><a href="../../../chat.html">ü§ñ ChatBot</a></li>
          <li><a href="../../../plantation.html">üå≥ Plantation</a></li>
          <li><a href="/crop_planning/">üìÖ Crop Planning</a></li>
          <li><a href="../../../Labour_Alerts/templates/labour.html">‚ö† Labour Alerts</a></li>
        </ul>
      </nav>
    </div>
    <div class="hero">
      <h2>Crop Price Tracker</h2>
      <p>Get up-to-date market prices for crops across India</p>
    </div>
    <div class="main-content">
      <form method="POST" id="priceForm" class="form-row-horizontal" style="display: flex; gap: 1.5rem; flex-wrap: wrap; align-items: center;">
        <div class="form-row" style="display: flex; flex-direction: column; flex: 1; min-width: 200px;">
          <label for="crop"><i class="fas fa-seedling"></i> Select Crop</label>
          <select name="crop" id="crop" required style="padding: 0.4rem; border-radius: 6px; border: 1px solid #ccc;">
            <option value="">-- Choose Crop --</option>
            {% for crop in crops %}
            <option value="{{ crop }}">{{ crop }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-row" style="display: flex; flex-direction: column; flex: 1; min-width: 200px;">
          <label for="state"><i class="fas fa-map-marker-alt"></i> Select State</label>
          <select name="state" id="state" required disabled style="padding: 0.4rem; border-radius: 6px; border: 1px solid #ccc;">
            <option value="">-- First select a crop --</option>
          </select>
        </div>

        <div class="form-row" style="display: flex; flex-direction: column; flex: 1; min-width: 200px;">
          <label for="market"><i class="fas fa-store"></i> Select Market</label>
          <select name="market" id="market" required disabled style="padding: 0.4rem; border-radius: 6px; border: 1px solid #ccc;">
            <option value="">-- First select a state --</option>
          </select>
        </div>

        <div class="form-buttons" style="display: flex; flex-direction: column; gap: 0.75rem; min-width: 140px;">
          <button type="submit" class="submit-button" id="submitBtn" disabled style="background-color: #2e7d32; color: white; border: none; padding: 0.6rem; border-radius: 8px; font-weight: 600; cursor: pointer;">
            <i class="fas fa-chart-line"></i> Track Prices
          </button>
          <button type="button" id="clearBtn" style="background-color: #2e7d32; color: white; border: none; padding: 0.6rem; border-radius: 8px; font-weight: 600; cursor: pointer;">
            <i class="fas fa-times"></i> Clear
          </button>
        </div>
      </form>

      <div class="results-table-container" style="display:none;">
      </div>
    </div>

    {% if error %}
    <div class="error"><strong>‚ö† Error:</strong> {{ error }}</div>
    {% endif %} {% if result %}
    <div class="results-container">
      <h3>üìà Latest Market Prices</h3>
      <div class="price-grid">
        {% for row in result %}
        <div class="price-card">
          <div class="price-date">{{ row['arrival_date'] }}</div>
          <div class="price-amount">‚Çπ{{ row['modal_price'] }} / quintal</div>
          <div class="price-location">
            {{ row['market'] }}, {{ row['state'] }}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <script>
      const cropSelect = document.getElementById("crop");
      const stateSelect = document.getElementById("state");
      const marketSelect = document.getElementById("market");
      const submitBtn = document.getElementById("submitBtn");

      // Enable/disable submit button based on form completion
      function updateSubmitButton() {
        const isFormComplete =
          cropSelect.value && stateSelect.value && marketSelect.value;
        submitBtn.disabled = !isFormComplete;
      }

      cropSelect.addEventListener("change", function () {
        const loadingText = "Loading states...";
        stateSelect.innerHTML = `<option value="">${loadingText}</option>`;
        stateSelect.disabled = true;
        stateSelect.classList.add("loading");

        fetch("/crop_price_tracker/get_states?crop=" + this.value)
          .then((res) => res.json())
          .then((states) => {
            stateSelect.innerHTML =
              '<option value="">-- Select State --</option>';
            states.forEach((state) => {
              stateSelect.innerHTML += `<option value="${state}">${state}</option>`;
            });
            stateSelect.disabled = false;
            stateSelect.classList.remove("loading");

            marketSelect.innerHTML =
              '<option value="">-- First select a state --</option>';
            marketSelect.disabled = true;
            updateSubmitButton();
          })
          .catch((error) => {
            console.error("Error fetching states:", error);
            stateSelect.innerHTML =
              '<option value="">-- Error loading states --</option>';
            stateSelect.classList.remove("loading");
          });
      });

      // Load markets based on selected state
      stateSelect.addEventListener("change", function () {
        const crop = cropSelect.value;
        const state = this.value;

        if (state) {
          const loadingText = "Loading markets...";
          marketSelect.innerHTML = `<option value="">${loadingText}</option>`;
          marketSelect.disabled = true;
          marketSelect.classList.add("loading");

          fetch(`/crop_price_tracker/get_markets?crop=${crop}&state=${state}`)
            .then((res) => res.json())
            .then((markets) => {
              marketSelect.innerHTML =
                '<option value="">-- Select Market --</option>';
              markets.forEach((market) => {
                marketSelect.innerHTML += `<option value="${market}">${market}</option>`;
              });
              marketSelect.disabled = false;
              marketSelect.classList.remove("loading");
              updateSubmitButton();
            })
            .catch((error) => {
              console.error("Error fetching markets:", error);
              marketSelect.innerHTML =
                '<option value="">-- Error loading markets --</option>';
              marketSelect.classList.remove("loading");
            });
        } else {
          marketSelect.innerHTML =
            '<option value="">-- First select a state --</option>';
          marketSelect.disabled = true;
          updateSubmitButton();
        }
      });

      marketSelect.addEventListener("change", updateSubmitButton);

      // Form submission with loading state
      document
        .getElementById("priceForm")
        .addEventListener("submit", function () {
          submitBtn.classList.add("loading");
          submitBtn.textContent = "Fetching Prices...";
        });

      updateSubmitButton();
    </script>
    <script src="../../nav.js"></script>
    <script src="../../auth.js"></script>
    <script src="../../theme.js"></script>

    <footer class="footer">
      <p>&copy; 2025 AgriConnectHub. All rights reserved.</p>
    </footer>
  </body>
</html>
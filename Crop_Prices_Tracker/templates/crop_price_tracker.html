<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"/>
    <meta name="description" content="AgriConnectHub- Empowering Agriculture Through Technology."/>
    <title>Crop Price Tracker - AgriConnectHub</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../../style.css" />
    <link rel="stylesheet" href="../../main.css" />
    <link rel="stylesheet" href="../../theme.css" />
    <link rel="stylesheet" href="{{ url_for('crop_price_tracker.static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>

  <body>
  <div class="header-nav-wrapper">
    <header class="uniform-header">
      <div class="brand">
        <h2>Welcome to AgriConnectHub</h2>
      </div>
      <div class="header-buttons">
        <a href="../../../cropCalendar.html" class="calendar-button" title="Crop Calendar">
          <span class="calendar-icon">ðŸ“…</span>
          Calendar
        </a>
        <a href="../../../feed-back.html" class="feedback-button">Feedback</a>
        <a href="#" class="logout-button" onclick="showLogoutConfirmation()">Logout</a>
        <button class="theme-toggle" aria-label="Toggle dark/light mode">
          <i class="fas fa-sun sun-icon"></i>
          <i class="fas fa-moon moon-icon"></i>
          <span class="theme-text">Light</span>
        </button>
      </div>
    </header>

    
  </div>
    <div class="hero">
      <div class="hero-content">
        <div class="hero-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <h2>Crop Price Tracker</h2>
        <p>Get real-time market prices for crops across India with advanced analytics</p>
        <div class="hero-stats">
          <div class="stat-item">
            <span class="stat-number">500+</span>
            <span class="stat-label">Markets</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">100+</span>
            <span class="stat-label">Crops</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">Live</span>
            <span class="stat-label">Updates</span>
          </div>
        </div>
      </div>
    </div>
    
    <style>
      .hero {
        padding: 0.5rem 1rem !important;
        height: auto !important;
        min-height: auto !important;
      }
      
      .hero-content {
        max-width: 300px !important;
        margin: 0 auto;
      }
      
      .hero h2 {
        font-size: 1.5rem !important;
        margin-bottom: 0.3rem !important;
      }
      
      .hero p {
        font-size: 0.8rem !important;
        margin-bottom: 0.8rem !important;
      }
      
      .hero-stats {
        gap: 0.8rem !important;
        margin-top: 0.5rem !important;
      }
      
      .hero-icon {
        font-size: 1.5rem !important;
        margin-bottom: 0.3rem !important;
      }
    </style>
    
    <div class="main-container">
      <div class="search-section">
        <div class="search-header">
          <h3><i class="fas fa-search"></i> Find Market Prices</h3>
          <p>Select your crop, state, and market to get the latest pricing information</p>
        </div>
        
        <form method="POST" id="priceForm" class="price-form">
          <div class="form-grid">
            <div class="form-group">
              <label for="crop" class="form-label">
                <i class="fas fa-seedling"></i>
                <span>Select Crop</span>
              </label>
              <div class="select-wrapper">
                <select name="crop" id="crop" required class="form-select">
                  <option value="">Choose your crop...</option>
                  {% for crop in crops %}
                  <option value="{{ crop }}">{{ crop }}</option>
                  {% endfor %}
                </select>
                <i class="fas fa-chevron-down select-arrow"></i>
              </div>
            </div>

            <div class="form-group">
              <label for="state" class="form-label">
                <i class="fas fa-map-marker-alt"></i>
                <span>Select State</span>
              </label>
              <div class="select-wrapper">
                <select name="state" id="state" required disabled class="form-select">
                  <option value="">First select a crop...</option>
                </select>
                <i class="fas fa-chevron-down select-arrow"></i>
              </div>
            </div>

            <div class="form-group">
              <label for="market" class="form-label">
                <i class="fas fa-store"></i>
                <span>Select Market</span>
              </label>
              <div class="select-wrapper">
                <select name="market" id="market" required disabled class="form-select">
                  <option value="">First select a state...</option>
                </select>
                <i class="fas fa-chevron-down select-arrow"></i>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
              <i class="fas fa-chart-line"></i>
              <span>Track Prices</span>
              <div class="btn-loader"></div>
            </button>
            <button type="button" class="btn btn-secondary" id="clearBtn">
              <i class="fas fa-refresh"></i>
              <span>Clear All</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    {% if error %}
    <div class="alert alert-error">
      <div class="alert-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="alert-content">
        <strong>Error</strong>
        <p>{{ error }}</p>
      </div>
    </div>
    {% endif %}
    
    {% if result %}
    <div class="results-section">
      <div class="results-header">
        <h3><i class="fas fa-chart-bar"></i> Latest Market Prices</h3>
        <div class="results-count">{{ result|length }} records found</div>
      </div>
      
      <div class="price-grid">
        {% for row in result %}
        <div class="price-card">
          <div class="price-card-header">
            <div class="price-date">
              <i class="fas fa-calendar-alt"></i>
              {{ row['arrival_date'] }}
            </div>
            <div class="price-trend">
              <i class="fas fa-arrow-up trend-up"></i>
            </div>
          </div>
          
          <div class="price-main">
            <div class="price-amount">â‚¹{{ row['modal_price'] }}</div>
            <div class="price-unit">per quintal</div>
          </div>
          
          <div class="price-details">
            <div class="price-location">
              <i class="fas fa-map-marker-alt"></i>
              {{ row['market'] }}, {{ row['state'] }}
            </div>
            {% if row.get('min_price') and row.get('max_price') %}
            <div class="price-range">
              <span class="range-label">Range:</span>
              <span class="range-values">â‚¹{{ row['min_price'] }} - â‚¹{{ row['max_price'] }}</span>
            </div>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <script>
      const cropSelect = document.getElementById("crop");
      const stateSelect = document.getElementById("state");
      const marketSelect = document.getElementById("market");
      const submitBtn = document.getElementById("submitBtn");

      function updateSubmitButton() {
        const isFormComplete =
          cropSelect.value && stateSelect.value && marketSelect.value;
        submitBtn.disabled = !isFormComplete;
      }

      cropSelect.addEventListener("change", function () {
        const loadingText = "Loading states...";
        stateSelect.innerHTML = `<option value="">${loadingText}</option>`;
        stateSelect.disabled = true;
        stateSelect.classList.add("loading");

        fetch("/crop_price_tracker/get_states?crop=" + this.value)
          .then((res) => res.json())
          .then((states) => {
            stateSelect.innerHTML =
              '<option value="">-- Select State --</option>';
            states.forEach((state) => {
              stateSelect.innerHTML += `<option value="${state}">${state}</option>`;
            });
            stateSelect.disabled = false;
            stateSelect.classList.remove("loading");

            marketSelect.innerHTML =
              '<option value="">-- First select a state --</option>';
            marketSelect.disabled = true;
            updateSubmitButton();
          })
          .catch((error) => {
            console.error("Error fetching states:", error);
            stateSelect.innerHTML =
              '<option value="">-- Error loading states --</option>';
            stateSelect.classList.remove("loading");
          });
      });

      stateSelect.addEventListener("change", function () {
        const crop = cropSelect.value;
        const state = this.value;

        if (state) {
          const loadingText = "Loading markets...";
          marketSelect.innerHTML = `<option value="">${loadingText}</option>`;
          marketSelect.disabled = true;
          marketSelect.classList.add("loading");

          fetch(`/crop_price_tracker/get_markets?crop=${crop}&state=${state}`)
            .then((res) => res.json())
            .then((markets) => {
              marketSelect.innerHTML =
                '<option value="">-- Select Market --</option>';
              markets.forEach((market) => {
                marketSelect.innerHTML += `<option value="${market}">${market}</option>`;
              });
              marketSelect.disabled = false;
              marketSelect.classList.remove("loading");
              updateSubmitButton();
            })
            .catch((error) => {
              console.error("Error fetching markets:", error);
              marketSelect.innerHTML =
                '<option value="">-- Error loading markets --</option>';
              marketSelect.classList.remove("loading");
            });
        } else {
          marketSelect.innerHTML =
            '<option value="">-- First select a state --</option>';
          marketSelect.disabled = true;
          updateSubmitButton();
        }
      });

      marketSelect.addEventListener("change", updateSubmitButton);

      document.getElementById('clearBtn').addEventListener('click', function() {
        cropSelect.value = '';
        stateSelect.innerHTML = '<option value="">First select a crop...</option>';
        stateSelect.disabled = true;
        marketSelect.innerHTML = '<option value="">First select a state...</option>';
        marketSelect.disabled = true;
        updateSubmitButton();
      });

      document.getElementById("priceForm").addEventListener("submit", function () {
        submitBtn.classList.add("loading");
        const btnText = submitBtn.querySelector('span');
        const btnIcon = submitBtn.querySelector('i');
        btnText.textContent = "Fetching Prices...";
        btnIcon.className = "fas fa-spinner fa-spin";
      });

      updateSubmitButton();
    </script>
    <script src="../../nav.js"></script>
    <script src="../../theme.js"></script>
    
    <script>
      function showLogoutConfirmation() {
        Swal.fire({
          title: 'Confirm Logout',
          text: 'Are you sure you want to logout?',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Yes, logout',
          cancelButtonText: 'Cancel'
        }).then((result) => {
          if (result.isConfirmed) {
            localStorage.removeItem('currentUser');
            window.location.href = '/';
          }
        });
      }
    </script>

    <footer class="footer">
      <p>&copy; 2025 AgriConnectHub. All rights reserved.</p>
    </footer>
        <script>
    // Shared Footer Loader
    document.addEventListener('DOMContentLoaded', function() {
      // Create footer if it doesn't exist
      if (!document.querySelector('.site-footer')) {
        const footerHTML = `
          <style>
            .site-footer {
              background: linear-gradient(135deg, #2e7d32, #66bb6a);
              color: #fff;
              margin-top: auto;
              padding: 1.5rem;
              text-align: center;
              font-size: 0.9rem;
              width: 100%;
              display: flex;
              justify-content: center;
              align-items: center;
            }
            .site-footer p {
              margin: 0;
              text-align: center;
            }
            .site-footer a {
              color: #fff;
              text-decoration: none;
            }
            .site-footer a:hover {
              text-decoration: underline;
            }
          </style>
          <footer class="site-footer">
            <p>&copy; 2025 Rural-IT-Hub. All rights reserved. powered by technoble.solutions. Email: <a href="mailto:admin@ruralithub.net">admin@ruralithub.net</a></p>
          </footer>
        `;
        
        // Insert footer before closing body tag
        document.body.insertAdjacentHTML('beforeend', footerHTML);
      }
    });
  </script>
</body>
</html>
